<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Scratchblocks SVG Generator</title>
  <script src="https://scratchblocks.github.io/js/scratchblocks-v3.4-min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #output { word-break: break-all; }
  </style>
</head>
<body>
  <div id="container" style="display:none;"></div>
  <p>Lien de l’image SVG :</p>
  <div id="output"></div>

  <script>
    function getParams() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return {
        style: params.get('style') || 'scratch3',
        script: params.get('script') || ''
      };
    }

    function createDataUrl(svg) {
      // Clone le SVG et ajoute les espaces de noms si manquants
      const clone = svg.cloneNode(true);
      if (!clone.getAttribute('xmlns')) {
        clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      }
      if (!clone.getAttribute('xmlns:xlink')) {
        clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      }
      const svgText = new XMLSerializer().serializeToString(clone);
      const encoded = encodeURIComponent(svgText)
        .replace(/'/g, "%27")
        .replace(/"/g, "%22");
      return `data:image/svg+xml;charset=utf-8,${encoded}`;
    }

    function generate() {
      const { style, script } = getParams();
      if (!script) {
        document.getElementById('output').textContent = 'Erreur : aucun script fourni.';
        return;
      }

      const container = document.getElementById('container');
      container.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'scratchblocks';
      div.textContent = decodeURIComponent(script);
      container.appendChild(div);

      scratchblocks.renderMatching('.scratchblocks', { style });

      setTimeout(() => {
        const svg = container.querySelector('svg');
        if (svg) {
          const url = createDataUrl(svg);
          document.getElementById('output').textContent = url;
        } else {
          document.getElementById('output').textContent = 'Erreur : SVG non généré.';
        }
      }, 300);
    }

    generate();
  </script>
</body>
</html>
