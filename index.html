<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Scratchblocks PNG URL Generator</title>
<script src="https://scratchblocks.github.io/js/scratchblocks-v3.4-min.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  textarea { width: 100%; height: 100px; }
</style>
</head>
<body>

<h1>URL de l'image générée</h1>
<textarea id="outputUrl" readonly>Chargement...</textarea>

<script>
function getParams() {
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  return {
    style: params.get('style') || 'scratch3',
    script: params.get('script') || ''
  };
}

async function svgToPngUrl(svg) {
  return new Promise((resolve) => {
    const svgData = new XMLSerializer().serializeToString(svg);
    const img = new Image();
    const svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = url;
  });
}

async function renderScript() {
  const {style, script} = getParams();
  if (!script) {
    document.getElementById('outputUrl').value = 'Aucun script fourni.';
    return;
  }

  const div = document.createElement('div');
  div.className = 'scratchblocks';
  div.textContent = decodeURIComponent(script);
  document.body.appendChild(div);

  scratchblocks.renderMatching('.scratchblocks', { style });

  // Attendre le rendu SVG
  setTimeout(async () => {
    const svg = div.querySelector('svg');
    if (svg) {
      const dataUrl = await svgToPngUrl(svg);
      document.getElementById('outputUrl').value = dataUrl;
    } else {
      document.getElementById('outputUrl').value = 'Erreur : SVG non généré.';
    }
    div.remove();
  }, 300);
}

renderScript();
</script>

</body>
</html>
